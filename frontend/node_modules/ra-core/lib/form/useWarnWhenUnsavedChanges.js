"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var react_1 = require("react");
var react_final_form_1 = require("react-final-form");
var react_router_dom_1 = require("react-router-dom");
var i18n_1 = require("../i18n");
/**
 * Display a confirmation dialog if the form has unsaved changes.
 * - If the user confirms, the navigation continues and the changes are lost.
 * - If the user cancels, the navigation is cancelled and the changes are kept.
 */
var useWarnWhenUnsavedChanges = function (enable, formRootPathname) {
    var history = (0, react_router_dom_1.useHistory)();
    var translate = (0, i18n_1.useTranslate)();
    var _a = (0, react_final_form_1.useFormState)(UseFormStateSubscription), pristine = _a.pristine, submitSucceeded = _a.submitSucceeded, submitting = _a.submitting;
    var initialLocation = (0, react_1.useRef)(formRootPathname || history.location.pathname);
    (0, react_1.useEffect)(function () {
        if (!enable) {
            return;
        }
        var release = history.block(function (location) {
            var isInsideForm = location.pathname.startsWith(initialLocation.current);
            if (!pristine && !isInsideForm && !submitSucceeded && !submitting) {
                return translate('ra.message.unsaved_changes');
            }
            return undefined;
        });
        return function () {
            if (release) {
                release();
            }
        };
    }, [pristine, enable, history, translate, submitSucceeded, submitting]);
};
var UseFormStateSubscription = {
    // For some reason, subscribing only to pristine does not rerender when a field become dirty
    // because it has a defaultValue (not initialValue as setting an initialValue does not make the field dirty)
    subscription: {
        pristine: true,
        dirtyFields: true,
        submitSucceeded: true,
        submitting: true,
    },
};
exports.default = useWarnWhenUnsavedChanges;
